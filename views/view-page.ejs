<div class="container mt-5">
  <div class="row">
    <!-- Property Images -->
    <div class="col-md-6">
      <% if (listing.images && listing.images.length> 1) { %>
        <div id="propertyCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner">
            <% listing.images.forEach((img, index)=> { %>
              <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                <img src="<%= img.url %>" class="d-block w-100 rounded shadow" alt="<%= listing.title %>">
              </div>
              <% }) %>
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
        <% } else { %>
          <img src="<%= listing.image.url %>" class="img-fluid rounded shadow" alt="<%= listing.title %>">
          <% } %>
    </div>

    <!-- Property Details -->
    <div class="col-md-6">
      <h2 class="fw-bold">
        <%= listing.title %>
      </h2>
      <h4 class="text-primary">&#8377; <%= listing.price.toLocaleString("en-IN") %> / night</h4>
      <p class="mt-3">
        <%= listing.description %>
      </p>

      <!-- Amenities -->
      <% if (listing.amenities && listing.amenities.length> 0) { %>
        <h5 class="mt-4">Amenities:</h5>
        <ul>
          <% listing.amenities.forEach(amenity=> { %>
            <li>
              <%= amenity %>
            </li>
            <% }) %>
        </ul>
        <% } %>

          <!-- Ratings Placeholder -->
          <% if (listing.rating) { %>
            <div class="mt-3">
              <strong>Rating:</strong>
              <span class="text-warning">
                <% for(let i=1; i <=5; i++) { %>
                  <i class="fa <%= i <= listing.rating ? 'fa-star' : 'fa-star-o' %>"></i>
                  <% } %>
              </span>
            </div>
            <% } %>

              <div class="mt-4 d-flex gap-3">

                <!-- Book Now -->
                <% if (user) { %>
                  <a href="/booking/<%= listing.id %>" class="btn btn-success btn-lg px-4">
                    Book Now
                  </a>
                  <% } else { %>
                    <a href="/auth" class="btn btn-success btn-lg px-4">
                      Book Now
                    </a>
                    <% } %>

                      <!-- Wishlist -->
                      <% if (user) { %>
                        <button id="wishlist-btn" data-id="<%= listing.id %>" data-saved="<%= isWishlisted %>"
                          type="button"
                          class="btn btn-lg px-4 <%= isWishlisted ? 'btn-primary' : 'btn-outline-primary' %>">

                          <i
                            class="fa <%= isWishlisted ? 'fa-solid fa-heart text-danger' : 'fa-regular fa-heart' %> me-2"></i>

                          <span class="wishlist-text">
                            <%= isWishlisted ? 'Saved' : 'Save to Wishlist' %>
                          </span>

                        </button>
                        <% } else { %>
                          <a href="/auth" class="btn btn-outline-primary btn-lg px-4">
                            <i class="fa-regular fa-heart me-2"></i>
                            Save to Wishlist
                          </a>
                          <% } %>


              </div>

    </div>
  </div>

  <!-- Optional: Back Button -->
  <div class="mt-5">
    <a href="/" class="btn btn-outline-secondary">‚Üê Back to Listings</a>
  </div>
</div>

<!-- wishlist script -->
<% if (user) { %>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("wishlist-btn");
    if (!btn) return;
  
    btn.addEventListener("click", async () => {
      const propertyId = btn.dataset.id;
  
      btn.disabled = true;
  
      try {
        const response = await fetch("/wishlist/toggle", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ propertyId })
        });
  
        const data = await response.json();
        if (!response.ok) throw new Error();
  
        const icon = btn.querySelector("i");
        const text = btn.querySelector(".wishlist-text");
  
        if (data.saved) {
          btn.classList.remove("btn-outline-primary");
          btn.classList.add("btn-primary");
  
          icon.classList.remove("fa-regular");
          icon.classList.add("fa-solid", "text-danger");
  
          text.textContent = "Saved";
        } else {
          btn.classList.remove("btn-primary");
          btn.classList.add("btn-outline-primary");
  
          icon.classList.remove("fa-solid", "text-danger");
          icon.classList.add("fa-regular");
  
          text.textContent = "Save to Wishlist";
        }
  
      } catch (error) {
        console.error(error);
        alert("Something went wrong");
      } finally {
        btn.disabled = false;
      }
    });
  });
  </script>
  <% } %>
  